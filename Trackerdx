<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Commander Life Tracker DX</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=VT323&family=DotGothic16&family=Xanh+Mono&display=swap" rel="stylesheet" />

  <style>
    :root {
      --terminal-green: #8bffb5;
      --terminal-bright: #b9ffd2;
      --terminal-bg-dark: #000000;
      --terminal-bg-mid: #02170a;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      font-family: 'Share Tech Mono', monospace;
      background: radial-gradient(circle at center, #04351a 0, #02140b 55%, #000000 100%);
      color: var(--terminal-green);
    }

    /* Bitcrushed background canvas (under everything) */
    #bgCanvas {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
    }

    /* VHS overlay elements */
    .vhs-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 3;
    }

    .vhs-scanlines {
      width: 100%;
      height: 100%;
      background-image: repeating-linear-gradient(
        to right,
        rgba(139, 255, 181, 0.09) 0px,
        rgba(139, 255, 181, 0.09) 2px,
        transparent 4px
      );
      mix-blend-mode: screen;
      opacity: 0.7;
    }

    .vhs-timestamp {
      position: absolute;
      top: 10px;
      left: 12px;
      font-size: 1.25rem;
      color: var(--terminal-bright);
      letter-spacing: 0.15em;
      text-shadow: 0 0 4px rgba(0, 255, 128, 0.8), 0 0 8px rgba(0, 255, 128, 0.5);
    }

    .vhs-record-dot {
      display: inline-block;
      width: 0.6em;
      height: 0.6em;
      background-color: var(--terminal-bright);  /* green now */
      border-radius: 50%;
      margin-left: 0.4em;
      animation: blink 1s steps(1, start) infinite;
      vertical-align: middle;
      box-shadow: 0 0 6px rgba(185, 255, 210, 0.9), 0 0 10px rgba(185, 255, 210, 0.7);
    }

    @keyframes blink {
      50% {
        opacity: 0;
      }
    }

    .commander-label {
      position: absolute;
      bottom: 10px;
      left: 12px;
      font-family: 'DotGothic16', sans-serif;
      font-size: 1.1rem;
      color: var(--terminal-bright);
      text-shadow: 0 0 4px rgba(0, 255, 128, 0.8);
    }

    /* Top-right controls: reset + image upload */
    .top-right-controls {
      position: absolute;
      top: 8px;
      right: 12px;
      display: flex;
      gap: 10px;
      z-index: 5;
    }

    .icon-btn {
      background: transparent;
      border: none;
      padding: 4px;
      cursor: pointer;
      color: var(--terminal-bright);
      display: flex;
      align-items: center;
      justify-content: center;
      filter: drop-shadow(0 0 4px rgba(0, 255, 140, 0.8));
    }

    .icon-btn svg {
      width: 22px;
      height: 22px;
      fill: currentColor;
    }

    /* Fullscreen button bottom-right */
    .fullscreen-btn {
      position: absolute;
      bottom: 10px;
      right: 12px;
      font-size: 2rem;
      background: none;
      border: none;
      color: var(--terminal-bright);
      cursor: pointer;
      z-index: 4;
      text-shadow: 0 0 6px rgba(0, 255, 120, 0.8);
    }

    /* Main grid – spacing similar to “good” version */
    .container {
      position: relative;
      z-index: 2;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      width: 100%;
      height: 100%;
      padding-block: 10vh;
      box-sizing: border-box;
      row-gap: 16vh;
      align-content: space-between;
    }

    .player {
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .player-inner {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transform: rotate(0deg);
      text-shadow: 0 0 4px rgba(139, 255, 181, 0.7);
    }

    .left .player-inner {
      transform: rotate(90deg);
    }

    .right .player-inner {
      transform: rotate(-90deg);
    }

    .life-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .life {
      font-family: 'VT323', monospace;
      font-size: 16vw;
      color: var(--terminal-bright);
      text-shadow:
        0 0 4px rgba(0, 255, 120, 0.9),
        0 0 10px rgba(0, 255, 120, 0.5),
        1px 0 0 rgba(0, 0, 0, 0.9);
      transition: opacity 0.2s ease-out;
    }

    /* KO skull overlay – doesn’t affect layout */
    .ko-skull {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20vw;
      opacity: 0;
      pointer-events: none;
      filter: drop-shadow(0 0 8px rgba(0, 255, 120, 0.9));
    }

    .player-ko .life {
      opacity: 0;
    }

    .player-ko .ko-skull {
      opacity: 1;
    }

    @keyframes koFlash {
      0% {
        filter: brightness(1);
      }
      40% {
        filter: brightness(2.2);
      }
      100% {
        filter: brightness(1);
      }
    }

    .ko-flash {
      animation: koFlash 0.3s ease-out 1;
    }

    .life-controls {
      display: flex;
      justify-content: space-around;
      width: 100%;
      margin-top: 8px;
    }

    .btn {
      background: none;
      border: none;
      font-size: 5vw;
      color: var(--terminal-bright);
      cursor: pointer;
      text-shadow: 0 0 4px rgba(0, 255, 140, 0.8);
    }

    .commander-damage {
      margin-top: 0.9em;
      display: flex;
      justify-content: center;
      gap: 2.3em;
    }

    .commander-group {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .commander-value {
      font-size: 5vw;
    }

    /* Centered vertical title */
    .center-title {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
      pointer-events: none;
    }

    .title-vertical {
      display: flex;
      flex-direction: column;
      align-items: center;
      transform: rotate(90deg);
      gap: 0.7rem;
    }

    .title-text {
      font-family: 'Xanh Mono', monospace;  /* back to Xanh Mono */
      font-size: 9vw;
      letter-spacing: 0.35em;
      color: var(--terminal-bright);
      text-shadow:
        0 0 4px rgba(0, 255, 128, 0.85),
        0 0 10px rgba(0, 255, 128, 0.6);
    }

    /* Hidden file input */
    #bgUploadInput {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Bitcrushed background canvas -->
  <canvas id="bgCanvas"></canvas>

  <!-- Top-right controls -->
  <div class="top-right-controls">
    <!-- Reset -->
    <button id="resetBtn" class="icon-btn" title="Reset game">
      <!-- restart icon -->
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M18.364 5.636A9 9 0 1 0 6.343 18.364l1.414-1.414A7 7 0 1 1 17 7h-2.586l2.828 2.828L18.364 5.636z" />
      </svg>
    </button>

    <!-- Image upload -->
    <button id="bgUploadBtn" class="icon-btn" title="Set background image">
      <!-- image-add-like icon -->
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M5 4a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3H5zm14 2a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h14zm-2 2h-2v2h-2v2h2v2h2v-2h2v-2h-2V8zm-9 1a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zm-1.586 8h9.172L13 12.5l-2.5 3L9 13l-2.586 4z" />
      </svg>
    </button>
  </div>

  <!-- Hidden file input -->
  <input type="file" id="bgUploadInput" accept="image/*" />

  <!-- VHS overlay -->
  <div class="vhs-overlay">
    <div class="vhs-scanlines"></div>
    <div class="vhs-timestamp" id="timestamp"></div>
    <div class="commander-label">コマンダーモード</div>
  </div>

  <!-- Fullscreen button -->
  <button id="fullscreenBtn" class="fullscreen-btn" onclick="toggleFullscreen()">⛶</button>

  <!-- Center title -->
  <div class="center-title">
    <div class="title-vertical">
      <div class="title-text">TRAX DX</div>
    </div>
  </div>

  <!-- Players -->
  <div class="container">
    <!-- Player 0 -->
    <div class="player left">
      <div class="player-inner" id="player-inner-0">
        <div class="life-wrapper">
          <div class="life" id="life0">40</div>
          <div class="ko-skull" id="skull0">☠</div>
        </div>
        <div class="life-controls">
          <button class="btn" onclick="changeLife(0, -1)">−</button>
          <button class="btn" onclick="changeLife(0, 1)">+</button>
        </div>
        <div class="commander-damage">
          <div class="commander-group">
            <button class="btn" onclick="changeCommander(0, 0, 1)">▲</button>
            <div class="commander-value" id="cmd-0-0">0</div>
            <button class="btn" onclick="changeCommander(0, 0, -1)">▼</button>
          </div>
          <div class="commander-group">
            <button class="btn" onclick="changeCommander(0, 1, 1)">▲</button>
            <div class="commander-value" id="cmd-0-1">0</div>
            <button class="btn" onclick="changeCommander(0, 1, -1)">▼</button>
          </div>
          <div class="commander-group">
            <button class="btn" onclick="changeCommander(0, 2, 1)">▲</button>
            <div class="commander-value" id="cmd-0-2">0</div>
            <button class="btn" onclick="changeCommander(0, 2, -1)">▼</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Player 1 -->
    <div class="player right">
      <div class="player-inner" id="player-inner-1">
        <div class="life-wrapper">
          <div class="life" id="life1">40</div>
          <div class="ko-skull" id="skull1">☠</div>
        </div>
        <div class="life-controls">
          <button class="btn" onclick="changeLife(1, -1)">−</button>
          <button class="btn" onclick="changeLife(1, 1)">+</button>
        </div>
        <div class="commander-damage">
          <div class="commander-group">
            <button class="btn" onclick="changeCommander(1, 0, 1)">▲</button>
            <div class="commander-value" id="cmd-1-0">0</div>
            <button class="btn" onclick="changeCommander(1, 0, -1)">▼</button>
          </div>
          <div class="commander-group">
            <button class="btn" onclick="changeCommander(1, 1, 1)">▲</button>
            <div class="commander-value" id="cmd-1-1">0</div>
            <button class="btn" onclick="changeCommander(1, 1, -1)">▼</button>
          </div>
          <div class="commander-group">
            <button class="btn" onclick="changeCommander(1, 2, 1)">▲</button>
            <div class="commander-value" id="cmd-1-2">0</div>
            <button class="btn" onclick="changeCommander(1, 2, -1)">▼</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Player 2 -->
    <div class="player left">
      <div class="player-inner" id="player-inner-2">
        <div class="life-wrapper">
          <div class="life" id="life2">40</div>
          <div class="ko-skull" id="skull2">☠</div>
        </div>
        <div class="life-controls">
          <button class="btn" onclick="changeLife(2, -1)">−</button>
          <button class="btn" onclick="changeLife(2, 1)">+</button>
        </div>
        <div class="commander-damage">
          <div class="commander-group">
            <button class="btn" onclick="changeCommander(2, 0, 1)">▲</button>
            <div class="commander-value" id="cmd-2-0">0</div>
            <button class="btn" onclick="changeCommander(2, 0, -1)">▼</button>
          </div>
          <div class="commander-group">
            <button class="btn" onclick="changeCommander(2, 1, 1)">▲</button>
            <div class="commander-value" id="cmd-2-1">0</div>
            <button class="btn" onclick="changeCommander(2, 1, -1)">▼</button>
          </div>
          <div class="commander-group">
            <button class="btn" onclick="changeCommander(2, 2, 1)">▲</button>
            <div class="commander-value" id="cmd-2-2">0</div>
            <button class="btn" onclick="changeCommander(2, 2, -1)">▼</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Player 3 -->
    <div class="player right">
      <div class="player-inner" id="player-inner-3">
        <div class="life-wrapper">
          <div class="life" id="life3">40</div>
          <div class="ko-skull" id="skull3">☠</div>
        </div>
        <div class="life-controls">
          <button class="btn" onclick="changeLife(3, -1)">−</button>
          <button class="btn" onclick="changeLife(3, 1)">+</button>
        </div>
        <div class="commander-damage">
          <div class="commander-group">
            <button class="btn" onclick="changeCommander(3, 0, 1)">▲</button>
            <div class="commander-value" id="cmd-3-0">0</div>
            <button class="btn" onclick="changeCommander(3, 0, -1)">▼</button>
          </div>
          <div class="commander-group">
            <button class="btn" onclick="changeCommander(3, 1, 1)">▲</button>
            <div class="commander-value" id="cmd-3-1">0</div>
            <button class="btn" onclick="changeCommander(3, 1, -1)">▼</button>
          </div>
          <div class="commander-group">
            <button class="btn" onclick="changeCommander(3, 2, 1)">▲</button>
            <div class="commander-value" id="cmd-3-2">0</div>
            <button class="btn" onclick="changeCommander(3, 2, -1)">▼</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Game state ---------- */
    const life = [40, 40, 40, 40];
    const commander = Array.from({ length: 4 }, () => [0, 0, 0]);

    const lifeEls = [];
    const skullEls = [];
    const playerInnerEls = [];

    for (let i = 0; i < 4; i++) {
      lifeEls[i] = document.getElementById(`life${i}`);
      skullEls[i] = document.getElementById(`skull${i}`);
      playerInnerEls[i] = document.getElementById(`player-inner-${i}`);
    }

    function updateDisplay() {
      for (let i = 0; i < 4; i++) {
        lifeEls[i].textContent = life[i];
        for (let j = 0; j < 3; j++) {
          document.getElementById(`cmd-${i}-${j}`).textContent = commander[i][j];
        }
      }
    }

    function changeLife(player, amount) {
      const prev = life[player];
      life[player] = Math.max(0, life[player] + amount);

      if (life[player] === 0 && prev > 0) {
        playerInnerEls[player].classList.add('player-ko', 'ko-flash');
        setTimeout(() => {
          playerInnerEls[player].classList.remove('ko-flash');
        }, 320);
      } else if (life[player] > 0 && prev === 0) {
        playerInnerEls[player].classList.remove('player-ko');
      }

      updateDisplay();
    }

    function changeCommander(player, index, amount) {
      commander[player][index] = Math.max(0, commander[player][index] + amount);
      updateDisplay();
    }

    /* ---------- Timer ---------- */
    let startTime = Date.now();

    function formatTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;

      const hh = hours.toString().padStart(2, '0');
      const mm = minutes.toString().padStart(2, '0');
      const ss = seconds.toString().padStart(2, '0');
      return `${hh}:${mm}:${ss}`;
    }

    function updateTimestamp() {
      const now = Date.now();
      const elapsed = now - startTime;
      const timeStr = `${formatTime(elapsed)} [PLAY] <span class="vhs-record-dot"></span>`;
      document.getElementById('timestamp').innerHTML = timeStr;
    }

    setInterval(updateTimestamp, 1000);
    updateTimestamp();

    /* ---------- Fullscreen ---------- */
    function toggleFullscreen() {
      const docEl = document.documentElement;
      if (!document.fullscreenElement) {
        docEl.requestFullscreen().catch(() => {});
      } else {
        document.exitFullscreen().catch(() => {});
      }
    }

    /* ---------- Reset ---------- */
    function resetGame() {
      for (let i = 0; i < 4; i++) {
        life[i] = 40;
        commander[i] = [0, 0, 0];
        playerInnerEls[i].classList.remove('player-ko', 'ko-flash');
      }
      startTime = Date.now();
      updateDisplay();
      updateTimestamp();
    }

    document.getElementById('resetBtn').addEventListener('click', () => {
      const ok = confirm('Reset all life totals, commander damage, and timer?');
      if (ok) resetGame();
    });

    updateDisplay();

    /* ---------- Bitcrushed background upload ---------- */
    const bgCanvas = document.getElementById('bgCanvas');
    const bgCtx = bgCanvas.getContext('2d');
    let currentBgImage = null;

    function resizeBgCanvas() {
      const dpr = window.devicePixelRatio || 1;
      const width = window.innerWidth;
      const height = window.innerHeight;

      bgCanvas.width = width * dpr;
      bgCanvas.height = height * dpr;

      bgCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
      if (currentBgImage) {
        drawBitcrushedBackground();
      } else {
        bgCtx.clearRect(0, 0, width, height);
      }
    }

    function drawBitcrushedBackground() {
      if (!currentBgImage) return;

      const width = window.innerWidth;
      const height = window.innerHeight;

      bgCtx.clearRect(0, 0, width, height);
      bgCtx.imageSmoothingEnabled = false;

      // Smaller pixels = higher crush resolution
      const crushWidth = 128;
      const crushHeight = Math.max(
        1,
        Math.floor((crushWidth * currentBgImage.height) / currentBgImage.width)
      );

      // Draw to tiny temp canvas
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = crushWidth;
      tempCanvas.height = crushHeight;
      const tctx = tempCanvas.getContext('2d');
      tctx.imageSmoothingEnabled = false;
      tctx.drawImage(currentBgImage, 0, 0, crushWidth, crushHeight);

      // Force to green palette (grayscale -> green channel)
      const imageData = tctx.getImageData(0, 0, crushWidth, crushHeight);
      const data = imageData.data;
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        const gray = 0.299 * r + 0.587 * g + 0.114 * b;
        data[i] = 0;         // R
        data[i + 1] = gray;  // G
        data[i + 2] = 0;     // B
        // alpha unchanged
      }
      tctx.putImageData(imageData, 0, 0);

      // Cover behaviour: scale to cover screen, crop excess
      const scale = Math.max(width / crushWidth, height / crushHeight);
      const drawW = crushWidth * scale;
      const drawH = crushHeight * scale;
      const dx = (width - drawW) / 2;
      const dy = (height - drawH) / 2;

      bgCtx.globalAlpha = 0.22; // subtle underlay
      bgCtx.drawImage(tempCanvas, 0, 0, crushWidth, crushHeight, dx, dy, drawW, drawH);
      bgCtx.globalAlpha = 1;
    }

    resizeBgCanvas();
    window.addEventListener('resize', resizeBgCanvas);

    const bgUploadBtn = document.getElementById('bgUploadBtn');
    const bgUploadInput = document.getElementById('bgUploadInput');

    bgUploadBtn.addEventListener('click', () => {
      bgUploadInput.click();
    });

    bgUploadInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          currentBgImage = img;
          drawBitcrushedBackground();
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>
